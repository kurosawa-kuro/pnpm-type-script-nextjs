# 1. パーサー定義
[PARSER]
    Name        json
    Format      json
    Time_Key    time
    Time_Format %Y-%m-%dT%H:%M:%S.%L
    Time_Keep   On

# 2. ベースフィルター: JSON解析（外側のJSON）
[FILTER]
    Name           parser
    Match          *
    Key_Name       log
    Parser         json
    Reserve_Data   true

# 3. CloudWatch出力（全てのログ）
[OUTPUT]
    Name                cloudwatch
    Match              *
    region             ${AWS_REGION}
    log_group_name     /aws/ecs/${ECS_CLUSTER}
    log_stream_prefix  ecs-fluentbit-
    auto_create_group  true
    retry_limit        2

# 4. ヘルスチェックパスの除外（Firehose用）
[FILTER]
    Name           grep
    Match          *
    Exclude        $pathname ^/health$

# 5. Firehose出力（ヘルスチェック除外）
[OUTPUT]
    Name              firehose
    Match            *
    region           ${AWS_REGION}
    delivery_stream  log-delivery-stream01
    retry_limit      2